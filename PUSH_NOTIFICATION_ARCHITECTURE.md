# Push Notification Architecture

**Modern Implementation Using Firebase Admin SDK**

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER DEVICE                               â”‚
â”‚                                                                â”‚
â”‚  ğŸ“± Mobile App (React Native + Expo)                          â”‚
â”‚      â”‚                                                         â”‚
â”‚      â”‚ 1. Get FCM Token                                       â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                        â†“                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 2. Register Token
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API SERVER (Node.js)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  POST /api/devices/register                              â”‚ â”‚
â”‚  â”‚  â”œâ”€ Store FCM token in database                         â”‚ â”‚
â”‚  â”‚  â””â”€ Associate with user ID                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  PostgreSQL Database                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚  Table: push_tokens                                  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ id (UUID)                                        â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ user_id (FK to users)                           â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ token (FCM token, 150+ chars)                   â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ platform (android/ios)                          â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ app (user/driver)                               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ created_at                                       â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ updated_at                                       â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                    LATER: SEND NOTIFICATION

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER REQUEST                              â”‚
â”‚                                                                â”‚
â”‚  POST /api/auth/otp/send                                      â”‚
â”‚  Body: { "userId": "xxx", "channel": "push" }                â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               AuthController.v2.ts                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  sendOtp()                                                â”‚ â”‚
â”‚  â”‚  â”œâ”€ Validate userId                                       â”‚ â”‚
â”‚  â”‚  â”œâ”€ Check channel = 'push'                               â”‚ â”‚
â”‚  â”‚  â””â”€ Call OtpService.sendOtp(phone, 'push', metadata)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   OtpService.ts                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  sendOtp(phone, 'push', metadata)                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ 1. Generate OTP code (4-6 digits)                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ 2. Store in otp_codes table                         â”‚ â”‚
â”‚  â”‚  â”œâ”€ 3. Find user by phone (SELECT ... WHERE phone=...)  â”‚ â”‚
â”‚  â”‚  â”œâ”€ 4. Get user's push token                            â”‚ â”‚
â”‚  â”‚  â”‚    SELECT * FROM push_tokens                          â”‚ â”‚
â”‚  â”‚  â”‚    WHERE user_id = xxx AND app = 'user'              â”‚ â”‚
â”‚  â”‚  â”‚    ORDER BY updated_at DESC LIMIT 1                   â”‚ â”‚
â”‚  â”‚  â””â”€ 5. Call PushService.send({token, title, body})     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PushService.ts                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  send(message)                                            â”‚ â”‚
â”‚  â”‚  â”œâ”€ Detect token type                                     â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ ExponentPushToken[...] â†’ Expo                   â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€ dTwD... â†’ FCM                                    â”‚ â”‚
â”‚  â”‚  â””â”€ Route to appropriate service                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â†“ (FCM Token)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  sendFCM(message)                                         â”‚ â”‚
â”‚  â”‚  â”œâ”€ 1. Check Firebase initialized                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ 2. Get Firebase Admin instance                       â”‚ â”‚
â”‚  â”‚  â”œâ”€ 3. Get messaging service                             â”‚ â”‚
â”‚  â”‚  â”œâ”€ 4. Prepare payload                                   â”‚ â”‚
â”‚  â”‚  â”‚    {                                                   â”‚ â”‚
â”‚  â”‚  â”‚      notification: { title, body },                   â”‚ â”‚
â”‚  â”‚  â”‚      data: { type: 'otp', code, phone },             â”‚ â”‚
â”‚  â”‚  â”‚      token: 'dTwD...',                                â”‚ â”‚
â”‚  â”‚  â”‚      android: { priority: 'high', ... },             â”‚ â”‚
â”‚  â”‚  â”‚      apns: { priority: '10', ... }                    â”‚ â”‚
â”‚  â”‚  â”‚    }                                                   â”‚ â”‚
â”‚  â”‚  â””â”€ 5. Send via messaging.send(payload)                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               FirebaseService.ts                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  getFirebaseAdmin()                                       â”‚ â”‚
â”‚  â”‚  â””â”€ Returns initialized Firebase Admin instance          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  Initialized on app startup:                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  initializeFirebase()                                     â”‚ â”‚
â”‚  â”‚  â”œâ”€ 1. Read service account JSON file                    â”‚ â”‚
â”‚  â”‚  â”‚    apps/api/ubexgo-a2b4a-firebase-...json            â”‚ â”‚
â”‚  â”‚  â”œâ”€ 2. Parse JSON                                         â”‚ â”‚
â”‚  â”‚  â”œâ”€ 3. Initialize admin.initializeApp({                  â”‚ â”‚
â”‚  â”‚  â”‚      credential: admin.credential.cert(serviceAccount)â”‚ â”‚
â”‚  â”‚  â”‚    })                                                  â”‚ â”‚
â”‚  â”‚  â””â”€ 4. Mark as initialized                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FIREBASE ADMIN SDK                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  admin.messaging().send(payload)                          â”‚ â”‚
â”‚  â”‚  â”œâ”€ 1. Generate OAuth 2.0 token (automatic)              â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€ Use service account private key                 â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€ Request token from oauth2.googleapis.com        â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€ Cache token (valid ~1 hour)                     â”‚ â”‚
â”‚  â”‚  â”‚    â””â”€ Auto-refresh when expired                       â”‚ â”‚
â”‚  â”‚  â”œâ”€ 2. Build FCM HTTP v1 API request                     â”‚ â”‚
â”‚  â”‚  â”‚    POST https://fcm.googleapis.com/v1/projects/...   â”‚ â”‚
â”‚  â”‚  â”‚    Headers: Authorization: Bearer {oauth-token}       â”‚ â”‚
â”‚  â”‚  â”œâ”€ 3. Send request                                       â”‚ â”‚
â”‚  â”‚  â””â”€ 4. Return message ID or error                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 GOOGLE FCM SERVERS                             â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  FCM HTTP v1 API                                          â”‚ â”‚
â”‚  â”‚  â”œâ”€ 1. Validate OAuth token                              â”‚ â”‚
â”‚  â”‚  â”œâ”€ 2. Validate FCM registration token                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ 3. Check device availability                         â”‚ â”‚
â”‚  â”‚  â”œâ”€ 4. Queue notification                                â”‚ â”‚
â”‚  â”‚  â””â”€ 5. Deliver to device                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER DEVICE                               â”‚
â”‚                                                                â”‚
â”‚  ğŸ“± Notification Received!                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ”” UbexGo tasdiqlash kodingiz                           â”‚ â”‚
â”‚  â”‚  Kodni haydovchi ilovasiga kiriting: 6298                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service Account JSON File                                  â”‚
â”‚  (ubexgo-ae910-firebase-adminsdk-fbsvc-b50ff8034e.json)   â”‚
â”‚                                                             â”‚
â”‚  {                                                          â”‚
â”‚    "type": "service_account",                              â”‚
â”‚    "project_id": "ubexgo-a2b4a",                          â”‚
â”‚    "private_key_id": "b200...",                            â”‚
â”‚    "private_key": "-----BEGIN PRIVATE KEY-----\n...",     â”‚
â”‚    "client_email": "firebase-adminsdk-...",                â”‚
â”‚    "token_uri": "https://oauth2.googleapis.com/token"     â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Read by FirebaseService.ts
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Firebase Admin SDK                                         â”‚
â”‚  admin.credential.cert(serviceAccount)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ When sending notification
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OAuth 2.0 Token Generation (Automatic)                    â”‚
â”‚                                                             â”‚
â”‚  1. Sign JWT with private key                              â”‚
â”‚     â”œâ”€ iss: client_email                                   â”‚
â”‚     â”œâ”€ scope: https://www.googleapis.com/auth/firebase    â”‚
â”‚     â”œâ”€ aud: token_uri                                       â”‚
â”‚     â””â”€ exp: now + 1 hour                                   â”‚
â”‚                                                             â”‚
â”‚  2. POST to https://oauth2.googleapis.com/token            â”‚
â”‚     Body: {                                                 â”‚
â”‚       grant_type: "urn:ietf:params:oauth:...",            â”‚
â”‚       assertion: "{signed-jwt}"                            â”‚
â”‚     }                                                       â”‚
â”‚                                                             â”‚
â”‚  3. Receive access token                                    â”‚
â”‚     {                                                       â”‚
â”‚       access_token: "ya29.c.b0Aa...",                     â”‚
â”‚       token_type: "Bearer",                                â”‚
â”‚       expires_in: 3600                                      â”‚
â”‚     }                                                       â”‚
â”‚                                                             â”‚
â”‚  4. Cache token (reuse for 1 hour)                         â”‚
â”‚  5. Auto-refresh when expired                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FCM HTTP v1 API Request                                    â”‚
â”‚                                                             â”‚
â”‚  POST https://fcm.googleapis.com/v1/projects/ubexgo-a2b4a/ â”‚
â”‚       messages:send                                         â”‚
â”‚                                                             â”‚
â”‚  Headers:                                                   â”‚
â”‚    Authorization: Bearer ya29.c.b0Aa...                    â”‚
â”‚    Content-Type: application/json                          â”‚
â”‚                                                             â”‚
â”‚  Body:                                                      â”‚
â”‚    {                                                        â”‚
â”‚      "message": {                                           â”‚
â”‚        "token": "dTwDv_YxR1WB1FKf82wcHQ:APA91b...",       â”‚
â”‚        "notification": {                                    â”‚
â”‚          "title": "UbexGo tasdiqlash kodingiz",           â”‚
â”‚          "body": "Kodni haydovchi ilovasiga kiriting: ..." â”‚
â”‚        }                                                    â”‚
â”‚      }                                                      â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
                SUCCESS âœ…
```

## ğŸ“Š Data Flow

### 1. Token Registration
```
Mobile App â†’ API â†’ Database
    â”‚         â”‚        â”‚
    â”‚         â”‚        â””â”€ Store: push_tokens table
    â”‚         â”‚           â”œâ”€ user_id
    â”‚         â”‚           â”œâ”€ token (FCM)
    â”‚         â”‚           â”œâ”€ platform
    â”‚         â”‚           â””â”€ app
    â”‚         â”‚
    â”‚         â””â”€ POST /api/devices/register
    â”‚            { token, platform, app }
    â”‚
    â””â”€ Firebase.messaging().getToken()
```

### 2. OTP Code Generation
```
User Request â†’ AuthController â†’ OtpService â†’ Database
     â”‚              â”‚                â”‚           â”‚
     â”‚              â”‚                â”‚           â””â”€ Store: otp_codes
     â”‚              â”‚                â”‚              â”œâ”€ code (random)
     â”‚              â”‚                â”‚              â”œâ”€ expires_at
     â”‚              â”‚                â”‚              â””â”€ channel='push'
     â”‚              â”‚                â”‚
     â”‚              â”‚                â””â”€ Generate 4-6 digit code
     â”‚              â”‚
     â”‚              â””â”€ POST /api/auth/otp/send
     â”‚                 { userId, channel: 'push' }
     â”‚
     â””â”€ User clicks "Send OTP"
```

### 3. Push Notification Delivery
```
OtpService â†’ PushService â†’ FirebaseService â†’ FCM â†’ Device
    â”‚            â”‚              â”‚              â”‚      â”‚
    â”‚            â”‚              â”‚              â”‚      â””â”€ Notification UI
    â”‚            â”‚              â”‚              â”‚         displayed
    â”‚            â”‚              â”‚              â”‚
    â”‚            â”‚              â”‚              â””â”€ Google FCM Servers
    â”‚            â”‚              â”‚                 validate & deliver
    â”‚            â”‚              â”‚
    â”‚            â”‚              â””â”€ Firebase Admin SDK
    â”‚            â”‚                 generates OAuth token
    â”‚            â”‚
    â”‚            â””â”€ Detect token type & send
    â”‚               sendFCM() for FCM tokens
    â”‚
    â””â”€ Get user's FCM token from database
```

## ğŸ”„ Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PushService.sendFCM()                                      â”‚
â”‚  â”œâ”€ Try to send                                             â”‚
â”‚  â””â”€ Catch errors                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Error Code Detection                                       â”‚
â”‚                                                             â”‚
â”‚  messaging/invalid-registration-token                       â”‚
â”‚    â†’ Token is invalid or expired                            â”‚
â”‚    â†’ Log: "User needs to re-register their device"        â”‚
â”‚    â†’ Action: Remove token from database                     â”‚
â”‚                                                             â”‚
â”‚  messaging/registration-token-not-registered                â”‚
â”‚    â†’ Token not registered with FCM                          â”‚
â”‚    â†’ Log: "Token is not registered"                        â”‚
â”‚    â†’ Action: Remove token, ask user to re-register         â”‚
â”‚                                                             â”‚
â”‚  app/invalid-credential                                     â”‚
â”‚    â†’ Service account credentials invalid                    â”‚
â”‚    â†’ Log: "Check Firebase service account JSON"            â”‚
â”‚    â†’ Action: Verify service account file                    â”‚
â”‚                                                             â”‚
â”‚  Network error                                              â”‚
â”‚    â†’ Can't reach googleapis.com                            â”‚
â”‚    â†’ Log: "Check DNS and internet connection"              â”‚
â”‚    â†’ Action: Test network connectivity                      â”‚
â”‚                                                             â”‚
â”‚  messaging/server-unavailable                               â”‚
â”‚    â†’ FCM servers temporarily down                           â”‚
â”‚    â†’ Log: "FCM servers unavailable, retry later"           â”‚
â”‚    â†’ Action: Implement retry logic                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Key Components

### 1. Service Account File
```
Location: apps/api/ubexgo-ae910-firebase-adminsdk-fbsvc-b50ff8034e.json

Purpose:
- Contains private key for OAuth 2.0
- Identifies service account
- Provides project configuration

Security:
- Mounted as read-only in Docker (:ro)
- Not in version control (should be .gitignored)
- Only accessible by API server

Used by:
- FirebaseService.ts (reads on initialization)
- Firebase Admin SDK (uses for auth)
```

### 2. Firebase Admin SDK
```
Package: firebase-admin (npm)

Purpose:
- Handles OAuth 2.0 token generation
- Provides FCM messaging API
- Manages token refresh automatically

Initialization:
- Once on app startup
- In apps/api/src/app.ts
- Calls initializeFirebase()

Usage:
- getFirebaseAdmin() to get instance
- admin.messaging() to get messaging service
- messaging.send() to send notifications
```

### 3. Database Tables

#### push_tokens
```sql
CREATE TABLE push_tokens (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  token VARCHAR(255) NOT NULL,      -- FCM token
  platform VARCHAR(20),              -- 'android' | 'ios'
  app VARCHAR(20),                   -- 'user' | 'driver'
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);

-- Example record:
{
  "id": "a983f068-c240-4285-892e-ce558f772849",
  "user_id": "78a8844e-c978-4f91-97bb-13dc6cc37dcb",
  "token": "dTwDv_YxR1WB1FKf82wcHQ:APA91bHeIDexi8l7togdT31x...",
  "platform": "android",
  "app": "user"
}
```

#### otp_codes
```sql
CREATE TABLE otp_codes (
  id SERIAL PRIMARY KEY,
  channel VARCHAR(10),               -- 'sms' | 'call' | 'push'
  target VARCHAR(20),                -- phone number
  code VARCHAR(10),                  -- OTP code
  expires_at TIMESTAMP,
  attempts INTEGER,
  meta JSONB,
  created_at TIMESTAMP
);

-- Example record:
{
  "id": 123,
  "channel": "push",
  "target": "+998916610061",
  "code": "6298",
  "expires_at": "2025-10-31T06:08:40.568Z",
  "attempts": 0,
  "meta": {
    "ip": "::ffff:172.19.0.1",
    "userAgent": "Mozilla/5.0..."
  }
}
```

## ğŸ“ˆ Performance

### Latency Breakdown

```
Total: ~500-1000ms

â”œâ”€ OTP Generation: ~10ms
â”‚   â””â”€ Random number generation
â”‚
â”œâ”€ Database Query: ~20ms
â”‚   â”œâ”€ Find user
â”‚   â””â”€ Get push token
â”‚
â”œâ”€ Firebase Admin SDK: ~470-970ms
â”‚   â”œâ”€ OAuth token (if not cached): 0-500ms
â”‚   â”‚   â”œâ”€ JWT signing: ~5ms
â”‚   â”‚   â”œâ”€ Network to googleapis.com: ~100-400ms
â”‚   â”‚   â””â”€ Token caching: ~1ms
â”‚   â”‚
â”‚   â”œâ”€ FCM API Request: ~200-300ms
â”‚   â”‚   â”œâ”€ Payload preparation: ~5ms
â”‚   â”‚   â”œâ”€ Network to FCM: ~150-250ms
â”‚   â”‚   â””â”€ Response processing: ~5ms
â”‚   â”‚
â”‚   â””â”€ Delivery to device: ~50-150ms
â”‚       â”œâ”€ FCM processing: ~20-50ms
â”‚       â””â”€ Network to device: ~30-100ms
```

### Optimization

- âœ… OAuth tokens cached (1 hour)
- âœ… Database connection pooled
- âœ… Asynchronous processing
- âœ… No blocking operations

## ğŸ”’ Security Layers

```
Layer 1: Transport Security
â””â”€ HTTPS/TLS for all communications

Layer 2: Authentication
â”œâ”€ OAuth 2.0 (Firebase Admin SDK)
â”œâ”€ JWT tokens (API authentication)
â””â”€ Service account credentials

Layer 3: Authorization
â”œâ”€ User must be authenticated to request OTP
â”œâ”€ Token must belong to requesting user
â””â”€ Rate limiting on OTP requests

Layer 4: Data Protection
â”œâ”€ Service account file read-only
â”œâ”€ Environment variables for secrets
â”œâ”€ Tokens stored in database (not logs)
â””â”€ OTP codes expire after 5 minutes

Layer 5: Network Security
â”œâ”€ Docker network isolation
â”œâ”€ DNS servers configured
â””â”€ Firewall rules (if production)
```

---

**This architecture is:**
- âœ… Modern (FCM HTTP v1 API)
- âœ… Secure (OAuth 2.0)
- âœ… Scalable (async, cached)
- âœ… Reliable (error handling)
- âœ… Maintainable (well-documented)
- âœ… Future-proof (Google-recommended)

